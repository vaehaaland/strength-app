name: Deploy prod

on:
  workflow_run:
    workflows: [ CI ]
    types: [ completed ]
    branches: [ main ]

jobs:
  deploy:
    if: >-
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.event == 'push' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Sync repo to server app dir
        run: |
          rsync -av --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude ".next" \
            ./ /home/deploy/strength-site/app/

      - name: Build and restart via docker compose
        run: |
          cd /home/deploy/strength-site
          docker compose up -d --build --remove-orphans

      - name: Smoke test
        run: |
          for i in {1..10}; do
            if curl -fsS http://127.0.0.1:3000/ >/dev/null; then
              echo "App is responding on attempt $i."
              exit 0
            fi

            echo "App not ready yet (attempt $i); waiting..."
            sleep 3
          done

          echo "App did not become ready in time." >&2
          exit 1
